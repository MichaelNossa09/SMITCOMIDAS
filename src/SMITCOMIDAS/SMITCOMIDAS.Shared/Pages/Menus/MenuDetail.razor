@page "/menus/{Id:int}"
@using Microsoft.AspNetCore.Authorization
@using SMITCOMIDAS.Shared.Models
@using SMITCOMIDAS.Shared.Services
@using SMITCOMIDAS.Shared.Services.SnackBar
@inject IMenuService MenuService
@inject NavigationManager Navigation
@inject IPlatformService Platform
@inject ISnackbar Snackbar
@inject IAuthService AuthService

<PageTitle>Detalle de Menú</PageTitle>

@if (isChecking)
{
    <div class="loading-container">
        <div class="loader"></div>
        <p>Verificando permisos...</p>
    </div>
}
else if (!isAuthorized)
{
    <div class="unauthorized-container">
        <div class="unauthorized-icon">🔒</div>
        <h2>Acceso Denegado</h2>
        <p>No tienes permisos suficientes para acceder a esta página.</p>
        <button class="btn-back" @onclick="GoBack">Volver al Inicio</button>
    </div>
}
else
{
    <div class="@(Platform.IsMobile ? "MENUDetail_containerMobile" : "MENUDetail_container")">
        <div class="@(Platform.IsMobile ? "MENUDetail_headerMobile" : "MENUDetail_header")">
            <div class="MENUDetail_backButton" @onclick="@(() => Navigation.NavigateTo("/menus"))">
                <span>←</span>
            </div>
            @if (menu != null)
            {
                <h1 class="MENUDetail_title">@menu.Nombre</h1>
            }
        </div>

        @if (isLoading)
        {
            <div class="MENUDetail_loadingContainer">
                <div class="MENUDetail_loader"></div>
                <p>Cargando...</p>
            </div>
        }
        else if (menu == null)
        {
            <div class="MENUDetail_errorContainer">
                <div class="MENUDetail_errorIcon">⚠️</div>
                <h3>No se encontró el menú</h3>
                <p>El menú que buscas no existe o no tienes permisos para verlo.</p>
                <button class="MENUDetail_primaryButton" @onclick="@(() => Navigation.NavigateTo("/menus"))">
                    Volver a Menús
                </button>
            </div>
        }
        else
        {
            <div class="MENUDetail_card">
                <div class="MENUDetail_menuInfo">
                    <div class="MENUDetail_menuHeader">
                        <div class="MENUDetail_menuTitle">
                            <h2>Información del Menú</h2>
                            <div class="MENUDetail_menuBadge MENUDetail_@GetEstadoClass(menu.Estado)">@menu.Estado</div>
                        </div>
                        <div class="MENUDetail_menuActions">
                            <button class="MENUDetail_editButton" @onclick="@(() => Navigation.NavigateTo($"/menus/editar/{Id}"))">
                                <span>✏️</span> Editar
                            </button>
                            @if (menu.Estado == EstadoMenu.Borrador)
                            {
                                <button class="MENUDetail_publishButton" @onclick="PublishMenu" disabled="@isActionLoading">
                                    <span>📢</span> @(isActionLoading ? "Publicando..." : "Publicar")
                                </button>
                            }
                            else if (menu.Estado == EstadoMenu.Publicado)
                            {
                                <button class="MENUDetail_deactivateButton" @onclick="DeactivateMenu" disabled="@isActionLoading">
                                    <span>🚫</span> @(isActionLoading ? "Desactivando..." : "Desactivar")
                                </button>
                            }
                        </div>
                    </div>

                    <div class="MENUDetail_detailsGrid">
                        <!-- Campo Descripción -->
                        <div class="MENUDetail_detailGroup MENUDetail_descriptionGroup">
                            <label class="MENUDetail_detailLabel">DESCRIPCIÓN:</label>
                            <div class="MENUDetail_detailValue MENUDetail_descriptionValue">@menu.Descripcion</div>
                        </div>

                        <!-- Campo Tipo de Menú -->
                        <div class="MENUDetail_detailGroup">
                            <label class="MENUDetail_detailLabel">TIPO DE MENÚ:</label>
                            <div class="MENUDetail_detailValue MENUDetail_typeValue">@menu.Tipo</div>
                        </div>

                        <!-- Campo Fecha Inicio -->
                        <div class="MENUDetail_detailGroup">
                            <label class="MENUDetail_detailLabel">FECHA INICIO:</label>
                            <div class="MENUDetail_detailValue MENUDetail_dateValue">@menu.FechaInicio.ToString("dd/MM/yyyy")</div>
                        </div>

                        <!-- Campo Fecha Fin -->
                        <div class="MENUDetail_detailGroup">
                            <label class="MENUDetail_detailLabel">FECHA FIN:</label>
                            <div class="MENUDetail_detailValue MENUDetail_dateValue">@menu.FechaFin.ToString("dd/MM/yyyy")</div>
                        </div>

                        <!-- Campo Proveedor -->
                        <div class="MENUDetail_detailGroup">
                            <label class="MENUDetail_detailLabel">PROVEEDOR:</label>
                            <div class="MENUDetail_detailValue MENUDetail_providerValue">@(menu.Proveedor?.NombreComercial ?? "N/A")</div>
                        </div>

                        <!-- Campo Fecha Creación -->
                        <div class="MENUDetail_detailGroup">
                            <label class="MENUDetail_detailLabel">FECHA DE CREACIÓN:</label>
                            <div class="MENUDetail_detailValue MENUDetail_dateCreatedValue">@menu.FechaCreacion.ToString("dd/MM/yyyy HH:mm")</div>
                        </div>
                    </div>
                </div>

                <div class="MENUDetail_elementosSection">
                    <div class="MENUDetail_sectionHeader">
                        <h2>Elementos del Menú</h2>
                        <button class="MENUDetail_addElementoButton" @onclick="@(() => Navigation.NavigateTo($"/menus/editar/{Id}"))">
                            <span>+</span> Agregar Elemento
                        </button>
                    </div>

                    @if (!menu.Elementos.Any())
                    {
                        <div class="MENUDetail_emptyElementos">
                            <div class="MENUDetail_emptyIcon">🍽️</div>
                            <p>Este menú no tiene elementos. Agrega elementos para que los clientes puedan ordenar.</p>
                            <button class="MENUDetail_addButton" @onclick="@(() => Navigation.NavigateTo($"/menus/editar/{Id}"))">
                                Agregar Primer Elemento
                            </button>
                        </div>
                    }
                    else
                    {
                        <div class="@(Platform.IsMobile ? "MENUDetail_elementosListMobile" : "MENUDetail_elementosList")">
                            @foreach (var elemento in menu.Elementos.OrderBy(e => e.Orden))
                            {
                                <div class="MENUDetail_elementoCard">
                                    <div class="MENUDetail_elementoImgContainer">
                                        @if (!string.IsNullOrEmpty(elemento.ImagenUrl))
                                        {
                                            <img src="@elemento.ImagenUrl" alt="@elemento.Nombre" class="MENUDetail_elementoImg" />
                                        }
                                        else
                                        {
                                            <div class="MENUDetail_elementoImgPlaceholder">
                                                <span>🍲</span>
                                            </div>
                                        }
                                        @* <div class="MENUDetail_elementoCategoria">@elemento.Categoria</div> *@
                                    </div>
                                    <div class="MENUDetail_elementoContent">
                                        <h3>@elemento.Nombre</h3>
                                        <p class="MENUDetail_elementoDesc">@elemento.Descripcion</p>
                                        <div class="MENUDetail_elementoPrecio">@elemento.Precio.ToString("C")</div>

                                        <div class="MENUDetail_elementoDisponibilidad">
                                            <div class="MENUDetail_disponibilidadTitle">Disponible en:</div>
                                            <div class="MENUDetail_diasSemana">
                                                @foreach (var dia in Enum.GetValues(typeof(DiaSemana)).Cast<DiaSemana>())
                                                {
                                                    var disponibilidad = elemento.Disponibilidades.FirstOrDefault(d => d.Dia == dia);
                                                    <div class="MENUDetail_diaBadge @(disponibilidad != null ? "MENUDetail_active" : "")">
                                                        @dia.ToString().Substring(0, 3)
                                                    </div>
                                                }
                                            </div>

                                            <div class="MENUDetail_disponibilidadDetalles">
                                                @foreach (var disponibilidad in elemento.Disponibilidades.OrderBy(d => d.Dia))
                                                {
                                                    <div class="MENUDetail_disponibilidadDetalle">
                                                        <span class="MENUDetail_disponibilidadDia">@disponibilidad.Dia:</span>
                                                        <span class="MENUDetail_disponibilidadComidas">
                                                            @if (disponibilidad.DisponibleAlmuerzo && disponibilidad.DisponibleCena)
                                                            {
                                                                <span>Almuerzo y Cena</span>
                                                            }
                                                            else if (disponibilidad.DisponibleAlmuerzo)
                                                            {
                                                                <span>Solo Almuerzo</span>
                                                            }
                                                            else if (disponibilidad.DisponibleCena)
                                                            {
                                                                <span>Solo Cena</span>
                                                            }

                                                            @if (disponibilidad.CantidadDisponible.HasValue)
                                                            {
                                                                <span class="MENUDetail_disponibilidadCantidad">
                                                                    (@disponibilidad.CantidadDisponible unidades)
                                                                </span>
                                                            }
                                                        </span>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                    <div class="MENUDetail_elementoActions">
                                        <button class="MENUDetail_iconButton" title="Editar"
                                                @onclick="@(() => Navigation.NavigateTo($"/menus/editar/{Id}"))">
                                            <span>✏️</span>
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="MENUDetail_errorMessage">@errorMessage</div>
                }
            </div>
        }
    </div>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private Menu menu;
    private string errorMessage = "";
    private bool isLoading = false;
    private bool isActionLoading = false;
    private bool isAuthorized = false;
    private bool isChecking = true;
    private bool initialized = false;
    private string role = "";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !initialized)
        {
            initialized = true;
            try
            {
                role = await AuthService.GetUserRoleAsync();
                isAuthorized = role == "Admin" || role == "Proveedor";

                if (!isAuthorized)
                {
                    await InvokeAsync(() =>
                    {
                        errorMessage = "No tiene permisos para acceder a esta página.";
                        isChecking = false;
                        StateHasChanged();
                    });
                    return;
                }

                await LoadMenu();
            }
            catch (Exception ex)
            {
                await InvokeAsync(() =>
                {
                    errorMessage = "Error al inicializar: " + ex.Message;
                    StateHasChanged();
                });
            }
            finally
            {
                await InvokeAsync(() =>
                {
                    isChecking = false;
                    StateHasChanged();
                });
            }
        }
    }

    private async Task LoadMenu()
    {
        isLoading = true;
        try
        {
            menu = await MenuService.GetMenuByIdAsync(Id, true);

            // Si es proveedor, verificar que el menú le pertenezca
            if (role == "Proveedor")
            {
                var userId = await AuthService.GetUserIdAsync();
                if (menu.Proveedor?.UserId != userId)
                {
                    await InvokeAsync(() =>
                    {
                        menu = null;
                        errorMessage = "No tienes permisos para ver este menú.";
                        StateHasChanged();
                    });
                }
            }
        }
        catch (Exception ex)
        {
            await InvokeAsync(() =>
            {
                errorMessage = "Error al cargar menú: " + ex.Message;
                Snackbar.Add(errorMessage, Severity.Error);
                StateHasChanged();
            });
        }
        finally
        {
            await InvokeAsync(() =>
            {
                isLoading = false;
                StateHasChanged();
            });
        }
    }

    private async Task PublishMenu()
    {
        try
        {
            isActionLoading = true;
            errorMessage = "";

            bool result = await MenuService.PublicarMenuAsync(Id);

            await InvokeAsync(async () =>
            {
                if (result)
                {
                    Snackbar.Add("Menú publicado exitosamente", Severity.Success);
                    await LoadMenu();
                }
                else
                {
                    errorMessage = "Error al publicar menú";
                    Snackbar.Add(errorMessage, Severity.Error);
                }
                StateHasChanged();
            });
        }
        catch (Exception ex)
        {
            await InvokeAsync(() =>
            {
                errorMessage = "Error: " + ex.Message;
                Snackbar.Add(errorMessage, Severity.Error);
                StateHasChanged();
            });
        }
        finally
        {
            await InvokeAsync(() =>
            {
                isActionLoading = false;
                StateHasChanged();
            });
        }
    }

    private async Task DeactivateMenu()
    {
        try
        {
            isActionLoading = true;
            errorMessage = "";

            bool result = await MenuService.DesactivarMenuAsync(Id);

            await InvokeAsync(async () =>
            {
                if (result)
                {
                    Snackbar.Add("Menú desactivado exitosamente", Severity.Success);
                    await LoadMenu();
                }
                else
                {
                    errorMessage = "Error al desactivar menú";
                    Snackbar.Add(errorMessage, Severity.Error);
                }
                StateHasChanged();
            });
        }
        catch (Exception ex)
        {
            await InvokeAsync(() =>
            {
                errorMessage = "Error: " + ex.Message;
                Snackbar.Add(errorMessage, Severity.Error);
                StateHasChanged();
            });
        }
        finally
        {
            await InvokeAsync(() =>
            {
                isActionLoading = false;
                StateHasChanged();
            });
        }
    }

    private string GetEstadoClass(EstadoMenu estado)
    {
        return estado switch
        {
            EstadoMenu.Borrador => "badge-borrador",
            EstadoMenu.Publicado => "badge-publicado",
            EstadoMenu.Inactivo => "badge-inactivo",
            _ => ""
        };
    }
    private void GoBack()
    {
        Navigation.NavigateTo("/home");
    }
}