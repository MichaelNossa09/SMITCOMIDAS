@using SMITCOMIDAS.Shared.Services
@inject IAuthService AuthService

<div class="home-web">
    <div class="dashboard-header">
        <h1>Bienvenido, su rol es @roleString</h1>
        <p class="dashboard-subtitle">Panel de Control - Sistema de Gestión</p>
    </div>
    @if (isAdmin)
    {
        <!-- Dashboard Admin -->
        <div class="dashboard-stats">
            <div class="stat-card stat-users">
                <div class="stat-icon">👥</div>
                <div class="stat-info">
                    <h3>Usuarios Registrados</h3>
                    <p class="stat-number">@totalUsuarios</p>
                    <span class="stat-label">Total en el sistema</span>
                </div>
            </div>
            <div class="stat-card stat-orders">
                <div class="stat-icon">📦</div>
                <div class="stat-info">
                    <h3>Pedidos Realizados</h3>
                    <p class="stat-number">@totalPedidos</p>
                    <span class="stat-label">Este mes</span>
                </div>
            </div>
            <div class="stat-card stat-companies">
                <div class="stat-icon">🏢</div>
                <div class="stat-info">
                    <h3>Compañías</h3>
                    <p class="stat-number">@totalCompanias</p>
                    <span class="stat-label">Activas</span>
                </div>
            </div>
            <div class="stat-card stat-cost-centers">
                <div class="stat-icon">💼</div>
                <div class="stat-info">
                    <h3>Centros de Costo</h3>
                    <p class="stat-number">@totalCentrosCosto</p>
                    <span class="stat-label">Configurados</span>
                </div>
            </div>
        </div>

        <div class="dashboard-actions">
            <h2>Acciones Rápidas</h2>
            <div class="action-grid">
                <button class="action-card" @onclick="@(() => NavigateTo("/perfil/crear"))">
                    <span class="action-icon">➕</span>
                    <span class="action-title">Nuevo Usuario</span>
                    <span class="action-desc">Registrar persona</span>
                </button>
                <button class="action-card" @onclick="@(() => NavigateTo("/companias/crear"))">
                    <span class="action-icon">🏛️</span>
                    <span class="action-title">Nueva Compañía</span>
                    <span class="action-desc">Agregar empresa</span>
                </button>
                <button class="action-card" @onclick="@(() => NavigateTo("/centroscosto/crear"))">
                    <span class="action-icon">💳</span>
                    <span class="action-title">Nuevo Centro</span>
                    <span class="action-desc">Crear centro de costo</span>
                </button>
                <button class="action-card" @onclick="@(() => NavigateTo("/pedidos/recepcion"))">
                    <span class="action-icon">📝</span>
                    <span class="action-title">Nuevo Pedido</span>
                    <span class="action-desc">Registrar solicitud</span>
                </button>
            </div>
        </div>
    }
    else
    {
        <!-- Dashboard Usuario -->
        <div class="dashboard-stats">
            <div class="stat-card stat-my-orders">
                <div class="stat-icon">✅</div>
                <div class="stat-info">
                    <h3>Pedidos Realizados</h3>
                    <p class="stat-number">@misPedidosRealizados</p>
                    <span class="stat-label">Total hasta hoy</span>
                </div>
            </div>
            <div class="stat-card stat-pending">
                <div class="stat-icon">⏳</div>
                <div class="stat-info">
                    <h3>Pedidos Pendientes</h3>
                    <p class="stat-number">@misPedidosPendientes</p>
                    <span class="stat-label">En proceso</span>
                </div>
            </div>
            <div class="stat-card stat-cancelled">
                <div class="stat-icon">❌</div>
                <div class="stat-info">
                    <h3>Pedidos Cancelados</h3>
                    <p class="stat-number">@misPedidosCancelados</p>
                    <span class="stat-label">Este mes</span>
                </div>
            </div>
            <div class="stat-card stat-month">
                <div class="stat-icon">📅</div>
                <div class="stat-info">
                    <h3>Total del Mes</h3>
                    <p class="stat-number">@misPedidosMes</p>
                    <span class="stat-label">Pedidos activos</span>
                </div>
            </div>
        </div>

        <div class="dashboard-actions">
            <h2>Mis Acciones</h2>
            <div class="action-grid">
                <button class="action-card" @onclick="@(() => NavigateTo("/menus"))">
                    <span class="action-icon">🍽️</span>
                    <span class="action-title">Ver Menús</span>
                    <span class="action-desc">Opciones disponibles</span>
                </button>
                <button class="action-card" @onclick="@(() => NavigateTo("/pedidos/nuevo"))">
                    <span class="action-icon">🛒</span>
                    <span class="action-title">Realizar Pedido</span>
                    <span class="action-desc">Nueva solicitud</span>
                </button>
                <button class="action-card" @onclick="@(() => NavigateTo("/pedidos"))">
                    <span class="action-icon">📋</span>
                    <span class="action-title">Mis Pedidos</span>
                    <span class="action-desc">Historial y estado</span>
                </button>
                <button class="action-card" @onclick="@(() => NavigateTo("/pqr"))">
                    <span class="action-icon">💬</span>
                    <span class="action-title">PQR</span>
                    <span class="action-desc">Peticiones y quejas</span>
                </button>
            </div>
        </div>
    }
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="error-toast">@errorMessage</div>
}
@code {
    [Inject] NavigationManager Navigation { get; set; }

    private int totalUsuarios = 0;
    private int totalPedidos = 0;
    private int totalCompanias = 0;
    private int totalCentrosCosto = 0;
    private int misPedidosRealizados = 0;
    private int misPedidosPendientes = 0;
    private int misPedidosCancelados = 0;
    private int misPedidosMes = 0;
    private string errorMessage = "";
    private string roleString = "";
    private bool initialized = false;
    private bool isAdmin = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !initialized)
        {
            initialized = true;
            try
            {
                var role = await AuthService.GetUserRoleAsync();
                isAdmin = role == "Admin";
                roleString = role;
                await CargarEstadisticas();
                StateHasChanged();
            }
            catch (Exception ex)
            {
                errorMessage = "Error al inicializar: " + ex.Message;
            }
        }
    }


    private async Task CargarEstadisticas()
    {
        try
        {
            // Implementar llamadas a servicios para obtener totales
            // totalUsuarios = await PersonasService.GetTotalPersonasAsync();
            // totalPedidos = await PedidosService.GetTotalPedidosMesAsync();
            // totalCompanias = await CompaniasService.GetTotalCompaniasAsync();
            // totalCentrosCosto = await CentrosCostoService.GetTotalCentrosCostoAsync();

            // Datos de prueba temporales
            if(isAdmin){
                totalUsuarios = 24;
                totalPedidos = 156;
                totalCompanias = 8;
                totalCentrosCosto = 15;
            }else{
                misPedidosRealizados = 45;
                misPedidosPendientes = 3;
                misPedidosCancelados = 2;
                misPedidosMes = 12;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar estadísticas: {ex.Message}");
        }
    }

    private void NavigateTo(string url)
    {
        Navigation.NavigateTo(url);
    }
}